# Step 3: Expose the AI Agent via RestController

## Accessing the AI Agent via a REST API
The CLI program was a nice way to get familiar with how the ChatClient is set up, but in real applications, your functionality is usually triggered via an API. Let's implement the Agent with the familiar Spring Boot Controller pattern.

---

##  Remove CommandLineRunner Beans
In your main application class (e.g., `SpringAiDemoApplication.java`), remove or comment out any existing `CommandLineRunner` beans that were used for CLI demos.
---

##  Synchronous Response Endpoint

Create `AgentController.java` in your `src/main/java/com/example/springaidemo` package:
```java
import org.springframework.ai.chat.ChatClient;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;

@RestController
@RequestMapping("/ask")
public class AgentController {
    private final ChatClient chatClient;

    public AgentController(ChatClient.Builder builder) {
        this.chatClient = builder.build();
    }

    // Synchronous response
    @GetMapping("/ask")
    public String ask(@RequestParam String prompt) {
        return chatClient.prompt()
            .user(message)
            .call().content();
    }
}
```

Run your Spring Boot application:
```sh
./mvnw spring-boot:run
# or
./gradlew bootRun
```
Test the synchronous endpoint:
```sh
curl --location "http://127.0.0.1:8080/ask?message=Why+did+my+last+Jenkins+build+for+backend-service+fail?"

```

Commit your changes:
```sh
git add src/main/java/com/example/springaidemo/AgentController.java src/main/resources/application.properties pom.xml
```
```sh
git commit -m "Expose AI agent via REST API with synchronous endpoint"
git push
```

---

##  Add Streaming Response to the Endpoint

Update `AgentController.java` to add the streaming endpoint:

```java
 @GetMapping(value = "/stream", produces = "text/event-stream")
public SseEmitter askStreaming(@RequestParam String message, HttpServletResponse response)
    throws IOException {

  // SSE emitter with 60s timeout
  SseEmitter emitter = new SseEmitter(60_000L);

  // Stream response from OpenAI
  chatClient.prompt()
      .user(message)
      .stream()  // streaming mode
      .content()// get token string
      .flatMap(chunk -> Flux.fromArray(chunk.split("\\s+")))
      .doOnNext(token -> {
        try {
          emitter.send(token); // send token immediately
          Thread.sleep(50);
        } catch (Exception e) {
          emitter.completeWithError(e);
        }
      })
      .doOnError(emitter::completeWithError)
      .doOnComplete(emitter::complete)
      .subscribe();

  return emitter;
}
```

Restart your Spring Boot application and test the streaming endpoint:
```sh
curl -s -N "http://127.0.0.1:8080/ask/stream?message=Why+did+my+last+Jenkins+build+for+backend-service+fail?" | sed -E 's/^data:[[:space:]]*//'
```

Commit your changes:
```sh
git add src/main/java/com/example/springaidemo/AgentController.java
```
```sh
git commit -m "Add streaming endpoint to AI agent REST API which have typing effect"
git push
```

##  Add Streaming Response to the Endpoint like typing effect
```java
 @GetMapping(value = "/stream/plain", produces = MediaType.TEXT_PLAIN_VALUE)
public ResponseBodyEmitter askStreamingPlain(@RequestParam String message) {
  ResponseBodyEmitter emitter = new ResponseBodyEmitter();
  
  chatClient.prompt()
      .user(message)
      .stream()  // streaming mode
      .content() // get token string
      .doOnNext(token -> {
        try {
          emitter.send(token); // send token immediately
        } catch (Exception e) {
          emitter.completeWithError(e);
        }
      })
      .doOnError(emitter::completeWithError)
      .doOnComplete(emitter::complete)
      .subscribe();

  return emitter;
}
```

Restart your Spring Boot application and test the streaming endpoint:
```sh
curl -s -N "http://127.0.0.1:8080/ask/stream/plain?message=Why+did+my+last+Jenkins+build+for+backend-service+fail?" 
```


Commit your changes:
```sh
git add src/main/java/com/example/springaidemo/AgentController.java
```
```sh
git commit -m "Add streaming endpoint to AI agent REST API which have typing effect"
git push
```

---

You have now exposed your AI agent via REST API endpoints for both synchronous and streaming responses, ready for integration with web, mobile, or other backend services.
