# Adding Context to Your AI Agent

![CI CD Pipeline](../images/CI_CD_Pipeline.png)

## Overview

`DocumentLoader` is a Spring `@Component` that implements `ApplicationRunner`. 
It loads all documents from the `dev-docs` folder (located in the classpath) into memory at application startup. 
The loaded documents are stored as a list of strings.


![CI CD Pipeline With Documents/logs](../images/CI_CD_Pipeline_docs.png)


## Copy the dev-docs Folder

- Copy the `dev-docs` folder into your `src/main/resources` directory.  
  [See `dev-docs`](../dev-docs) for the actual folder location.

##  Add DocumentLoader Component

```java

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;
import org.springframework.boot.ApplicationArguments;
import org.springframework.boot.ApplicationRunner;
import org.springframework.core.io.ClassPathResource;
import org.springframework.stereotype.Component;

@Component
public class DocumentLoader implements ApplicationRunner {

  private final List<String> documents = new ArrayList<>();
  private static final String DOCS_FOLDER = "dev-docs"; // relative to classpath: resources/docs

  @Override
  public void run(ApplicationArguments args) throws Exception {
    loadDocumentsFromFolder();
    System.out.println("Loaded " + documents.size() + " documents into memory.");
  }

  private void loadDocumentsFromFolder() throws IOException {
    ClassPathResource folderResource = new ClassPathResource(DOCS_FOLDER);
    Path folderPath = folderResource.getFile().toPath();

    if (Files.exists(folderPath) && Files.isDirectory(folderPath)) {
      Files.walk(folderPath)
          .filter(Files::isRegularFile) // only files
          .forEach(path -> {
            try {
              String content = Files.readString(path);
              documents.add(content);
            } catch (IOException e) {
              e.printStackTrace();
            }
          });
      System.out.println(
          "Loaded " + documents.size() + " documents recursively from folder: " + folderPath);
    } else {
      System.err.println("Docs folder not found: " + folderPath);
    }
  }

  public List<String> getDocuments() {
    return documents;
  }
}

```


## Use documents as context in AgentController

The `AgentController` can inject `DocumentLoader` as a dependency to access the loaded documents. For example:

```java

@RestController
@RequestMapping("/ask")
public class AgentController {

  private final ChatClient chatClient;
  private final DocumentLoader documentLoader;

  public AgentController(ChatClient.Builder builder, DocumentLoader documentLoader) {
    this.chatClient = builder.build();
    this.documentLoader = documentLoader;
  }

  @GetMapping
  public String ask(@RequestParam String message) {

    var documents = documentLoader.getDocuments();

    String context = String.join("\n", documents);

    return chatClient.prompt()
        .system("Use the following documents to answer the question:\n" + context)
        .user(message)
        .call().content();
  }

  @GetMapping(value = "/stream", produces = "text/event-stream")
  public SseEmitter askStreaming(@RequestParam String message, HttpServletResponse response)
      throws IOException {

    var documents = documentLoader.getDocuments();

    String context = String.join("\n", documents);

    // SSE emitter with 60s timeout
    SseEmitter emitter = new SseEmitter(60_000L);

    // Stream response from OpenAI
    chatClient.prompt()
        .system("Use the following documents to answer the question:\n" + context)
        .user(message)
        .stream()  // streaming mode
        .content()// get token string
        .flatMap(chunk -> Flux.fromArray(chunk.split("\\s+")))
        .doOnNext(token -> {
          try {
            emitter.send(token); // send token immediately
            Thread.sleep(50);
          } catch (Exception e) {
            emitter.completeWithError(e);
          }
        })
        .doOnError(emitter::completeWithError)
        .doOnComplete(emitter::complete)
        .subscribe();

    return emitter;
  }

  @GetMapping(value = "/stream/plain", produces = MediaType.TEXT_PLAIN_VALUE)
  public ResponseBodyEmitter askStreamingPlain(@RequestParam String message) {
    ResponseBodyEmitter emitter = new ResponseBodyEmitter();

    var documents = documentLoader.getDocuments();

    String context = String.join("\n", documents);

    chatClient.prompt()
        .system("Use the following documents to answer the question:\n" + context)
        .user(message)
        .stream()  // streaming mode
        .content() // get token string
        .doOnNext(token -> {
          try {
            emitter.send(token); // send token immediately
          } catch (Exception e) {
            emitter.completeWithError(e);
          }
        })
        .doOnError(emitter::completeWithError)
        .doOnComplete(emitter::complete)
        .subscribe();

    return emitter;
  }

}
```


## 3. Run the Application
Run your Spring Boot application:
```sh
./mvnw spring-boot:run
# or
./gradlew bootRun
```
Verify the output by sending requests to the `/ask` endpoint with context from the loaded documents:

```sh
curl --location "http://127.0.0.1:8080/ask?message=Why+did+my+last+Jenkins+build+for+backend-service+fail?"

```

Verify the output by sending requests to the `/ask/stream/plain` endpoint with context from the loaded documents:

```sh
curl -s -N "http://127.0.0.1:8080/ask/stream/plain?message=Why+did+my+last+Jenkins+build+for+backend-service+fail?"

```

## 4. Commit Changes to Git
After verifying the output, commit your changes:
```sh
git add src/main/java/com/example/springaidemo/service/DocumentLoader.java src/main/java/com/example/springaidemo/web/controller/AgentController.java
git commit -m "Add context loading component and integrate for prompting"
git push
```

